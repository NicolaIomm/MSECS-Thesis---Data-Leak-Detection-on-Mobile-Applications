\section{Application case: iLMeteo}
		\par \textbf{iLMeteo: previsioni meteo} is one of the most famous weather application available on Google Play Store, counting more than 10 Million downloads. Usually a weather forecast application is one of the really first application installed on a fresh device, if the user does not want to use the already bundled Android weather application. iLMeteo is a free application and like many other of this kind, a lot of advertising services are implemented in the application logic. 
		\subsection{Study detail}
			\par Once installed the application available from the Google Play Store and opened for the first time, the permission to use geolocalization is asked to the user. An expected behaviour since the application will deal with weather forecasts. \newline
			\par The analysis started with the HttpToolkit software, inspecting every outgoing request generated by the application. Each requests is made using the \textit{HTTPS} protocol, and then totally encrypted, but since we placed our network tool in the middle of the communication we are able to clearly observe all of them.  
			
			\subsubsection{Advertising services}
				\par Advertising-related requests cover by far the greatest chunk of requests generated, directed towards more than 20 different endpoints. The advertising services provider domains are \textit{criteo.com}, \textit{criteo.net}, \textit{adjust.com}, \textit{taboola.com}, \textit{g.doubleclick.net}, \textit{googlevideo.com}, \textit{googleadservices.com}, \textit{googlesyndacation.com}. Subdomains are not reported, but often a single advertising service provider use different subdomains to deliver advertisements.\newline
				Requests might assume a certain degree of precision in terms of information description. Most of these services will only send generic information on the device used. For example in the case of  \textit{googleads.g.doubleclick.net} the GET request is specifying some information device-related like device model, carrier identifier, Android API level. Others are more specific. The service offered by \textit{bidder.criteo.com} will include also device ID, screen size, screen orientation, current active session duration and country.
				
			\subsubsection{OneSignal: push notification service}
				\par A push notification service called \textit{OneSignal} is used, towards the endpoint \textit{api.signal.com}. Firstly the application contacts the server to register the current device as a \textit{iLMeteo} user sending information like \textit{external\_user\_id} (the id assocated to the user of the application in the context of the \textit{OneSignal} service), \textit{application\_id} (the id associated with the \textit{iLMeteo} application), \textit{device\_model} (sdk\_gphone64\_x86\_64 for the emulator), \textit{carrier} (\textit{T-Mobile} for the emulator). Once established the link between user and notification service, the subsequent GET requests will retrieve the notifications available for the specific \textit{user\_id} sent from the \textit{iLMeteo} service to the \textit{OneSignal} notification service platform.
			
			\subsubsection{Firebase: Analytics, Logging and Remote Configuration}
				\par The applications makes use of the \textit{Firebase} platform, thanks to \textit{iLMeteo} implements analytics and logging services. Developed by Google, Firebase keeps track of the user behaviour while using the application. The platform also provides a Remote configuration service able to differentiate the layout of the application basing on some informations expressed in the requests. The body of the POST request in this case have a \textit{JSON} structure in which informations on device are sent (sdk version, model, hardware, OS build, manufacturer, country, network type).
			
			\subsubsection{Android API: Location service}
				\par The interaction with Android API happens in order to deliver the geolocalization service, for which the application itself asked the permissions. As HttpToolkit shows, the \textit{gRPC} requests is sent towards the endpoint \textit{voilatile-pa.googleapi/google.internal.android.location.voilatile.v1.VoilaTileService/FindTiles}. The data in this case does not assume any recognizable structure. In fact, the payload of the request seems to be handled with an additional encryption process, over the TLS encrytion. 
				
			\subsubsection{iLMeteo: weather forecast}
				\par Finally the actual weather forecast service has been implemented in the application. The communication logic is really simple. The client communicates with \textit{iphone.ilmeteo.it/android-app.php} through GET requests. The server implements mainly two methods for delivering weather informations:
				\begin{enumerate}
					\item \textbf{getDB}: This method is responsible for filling up the database containing the whole list of places for which the user can ask weather informations for. The requests looks like this:
\begin{lstlisting}
GET /android-app.php?method=getDB&table=localita&format=sql&x=<getDB_action_token>&lang=eng&v=4.6&app=com.ilmeteo.android.ilmeteo&force_3h=0 HTTP/2
Host: iphone.ilmeteo.it
User-Agent: Dalvik/2.1.0 (Linux; U; Android 13; sdk_gphone64_x86_64 Build/TPB4.220624.004)
Connection: Keep-Alive
Accept-Encoding: gzip, deflate
\end{lstlisting}	
						The \textit{table} parameter specifies which table has to be retrieved.
						The \textit{format} parameter specifies the table format in which the data has to be sent.
						The \textit{x} parameter identifies an access token for the action \textit{getDB}. If the token is not correct than the request will be rejected by the server.\newline
						The response will contain in its body a list of \textit{SQL} commands, that will fill the application database with the informations relatives to the places available for weather forecasts. The body is essentially a 35 thousands lines of SQL commands: the first line will delete the already existing database, and the second line will create a new database:
\begin{lstlisting}
DROP TABLE IF EXISTS "n_l";
CREATE TABLE "n_l" ("lid" INTEGER PRIMARY KEY NOT NULL DEFAULT (0), "pid" CHAR, "rid" CHAR, "nid" CHAR, "nome" VARCHAR, "mare" INTEGER DEFAULT (0), "webcam" INTEGER DEFAULT (0), "nome_eng" VARCHAR, "cap" VARCHAR, "popolazione" INTEGER DEFAULT (0), "lat" FLOAT DEFAULT (0), "lon" FLOAT DEFAULT (0), "alt" INTEGER DEFAULT (0), "tipo" INTEGER DEFAULT (0) );
\end{lstlisting}	
						The following lines will be \textit{INSERT INTO} commands to add values to the database. Each line will identify a place available for weather forecast:
\begin{lstlisting}
INSERT INTO "n_l" VALUES(1,'PD','VEN','IT','Abano Terme',0,1,'Abano Terme','35031',19726, 45.36, 11.79, 14, -1 );
INSERT INTO "n_l" VALUES(3328,'RM','LAZ','IT','Guidonia Montecelio',0,0,'Guidonia Montecelio','00012',83736, 41.99, 12.72, 105, -1 );
INSERT INTO "n_l" VALUES(279,'LT','LAZ','IT','Aprilia',0,0,'Aprilia','04011',70349, 41.59, 12.65, 80, -1 );
\end{lstlisting}
						The final database will be queried by the mobile application when the user will direcly type in the location he wants to know the forecast about. The database is stored on the devices in the file \textit{/data/data/com.ilmeteo.android.ilmeteo/databases/ilmeteo.db}. Each place has an ID location, denoted as \textit{lid}, that will be used to retrieve forecasts for that location. In the listing above, Abano Terme has lid=1, Guidonia Montecelio has lid=3328, Aprilia has lid=279. Notice that the response body does not contains only places near the user location. In the 35 thousands lines there are the cities from the whole world.
					\item \textbf{situationAndForecast}: This method is responsible for retrieving weather forecasts for a specific location id. The request generated is to get the weather for Rome (id=5913) is:
\begin{lstlisting}
GET /android-app.php?method=situationAndForecast&type=0&id=5913&x=53153fd26a7f1469f1dd669a3dde06f0&lang=eng&v=4.6&app=com.ilmeteo.android.ilmeteo&force_3h=0 HTTP/2
Host: iphone.ilmeteo.it
User-Agent: Dalvik/2.1.0 (Linux; U; Android 13; sdk_gphone64_x86_64 Build/TPB4.220624.004)
Connection: Keep-Alive
Accept-Encoding: gzip, deflate
\end{lstlisting}	
					The \textit{type} parameter specifies which type of information the requests is asking for: 0 is for standard locations, 1 is for sea locations, 2 is for oceans, 3 for surfing location. \newline
					The \textit{id} parameter specifies the location id.\newline
					The \textit{x} is an access token that allows the client to use the method \textit{situationAndForecast}. In case this token is not verified, the requests will be rejected by the server.\newline
					Other parameters are less importants. 
					The response, in this case, is an \textit{XML} structure containing the information passed to the client in order to visualize the information in the Android application.
				\end{enumerate}
				
		\subsection{Results}
			\par The application does not directly handle private informations. Since there is no form of user authentication the only conclusions that can be drawed are traceable back to the device identifier the various services share. \newline
			\par It is interesting how the weather informations delivery has been implemented. In fact the requests to the \textit{iphone.ilmeteo.it} endpoint specifies the location id of the place the user is looking for the forecast. Since the location database is available and identical for every client, the link between location id and actual location is known. The history of the locations searched by the user might denote the city where the user lives. Anyway the communication protocol is protected by the TLS encryption: every data is encrypted and not visible from the outside. Establishing a Man-In-The-Middle attack the only informations retrievable are those related to the device. \newline
			\par The only viable approach would be to link the device identifier to a specific user, but it is something that is not possible within the boundaries of this single application, just because there is no \textit{user} concept in the application logic.
			
			\newpage
			